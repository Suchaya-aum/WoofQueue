{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Appointment{% endblock %}

{% block head %}
<div class="mx-auto text-center mb-4">
  <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Edit Appointment</h1>
</div>
{% endblock %}

{% block content %}
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow border border-orange-100 p-6">
        <form method="post">
            {% csrf_token %}

            <!-- ใช้ form เดิมของคุณเลย -->
            {{ appointmentform.non_field_errors }}

            <div class="space-y-4">
            {{ appointmentform.pet.errors }}
            <label class="block font-medium text-gray-700 mb-1">Pet</label>
            {{ appointmentform.pet }}

            {{ appointmentform.service.errors }}
            <label class="block font-medium text-gray-700 mb-1 mt-3">Services</label>
            {{ appointmentform.service }}

            {{ appointmentform.appointment_time.errors }}
            <label class="block font-medium text-gray-700 mb-1 mt-3">Appointment Time</label>
            {{ appointmentform.appointment_time }}

            {{ appointmentform.finish_time.errors }}
            <label class="block font-medium text-gray-700 mb-1 mt-3">Finish Time</label>
            {{ appointmentform.finish_time }}

            {{ appointmentform.status.errors }}
            <label class="block font-medium text-gray-700 mb-1 mt-3">Status</label>
            {{ appointmentform.status }}
            </div>

            <div class="flex gap-2 mt-6">
            <button class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">Save</button>
            <a href="{% url 'appointment' %}" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</a>
            </div>
        </form>
        </div>
        {% endblock %}
    </body>
</html>

{% block script %}
 <script>
        document.addEventListener("DOMContentLoaded", function () {
            const appointmentField = document.getElementById("id_appointment_time");
            const finishField = document.getElementById("id_finish_time");
            const serviceField = document.getElementById("id_service");

            function updateFinishTime() {
                const appointmentValue = appointmentField.value;
                const selectedOptions = Array.from(serviceField.selectedOptions);

                if (!appointmentValue || selectedOptions.length === 0) {
                    return;
                }

                // Parse appointment datetime
                const startDate = new Date(appointmentValue);
                if (isNaN(startDate)) return;

                // Extract durations from text (e.g. "Service Full Grooming - 90 minutes - $600.00 - Staff ID: staff1")
                let totalMinutes = 0;
                selectedOptions.forEach(opt => {
                    var id = parseInt(opt.value)
                    {% for service in service_list %}
                        if(id == {{service.id}}){
                            totalMinutes = totalMinutes + {{service.duration}}
                        }
                    {% endfor %}
                    // const match = opt.textContent.match(/(\d+)\s*minutes/);
                    // if (match) totalMinutes += parseInt(match[1]);
                });

                if (totalMinutes === 0) return;

                // Calculate finish datetime
                const finishDate = new Date(startDate.getTime() + totalMinutes * 60000);

                // Format correctly for datetime-local input
                const year = finishDate.getFullYear();
                const month = String(finishDate.getMonth() + 1).padStart(2, '0');
                const day = String(finishDate.getDate()).padStart(2, '0');
                const hours = String(finishDate.getHours()).padStart(2, '0');
                const minutes = String(finishDate.getMinutes()).padStart(2, '0');

                finishField.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            appointmentField.addEventListener("change", updateFinishTime);
            serviceField.addEventListener("change", updateFinishTime);
        });
    </script>
{% endblock %}